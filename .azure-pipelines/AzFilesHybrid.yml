trigger:
  branches:
    include:
      - 'master'
  paths:
    include:
      - .azure-pipelines/AzFilesHybrid.yml
      - AzFilesHybrid/**

pool:
  vmImage: 'windows-latest'

stages:
  - stage: Test
    displayName: 'Test AzFilesHybrid'
    jobs:
      - job: TestPowerShell5
        displayName: 'Test with PowerShell 5.1'
        steps:
          - checkout: self
          - powershell: |
              Set-Location -Path .\AzFilesHybrid
              .\init.ps1
              Test-Manifest
            displayName: 'Check .psd1 file with Test-ModuleManifest'
      - job: TestPowerShell7
        displayName: 'Test with PowerShell 7'
        steps:
          - checkout: self
          - pwsh: |
              Set-Location -Path .\AzFilesHybrid
              .\init.ps1
              Test-Manifest
            displayName: 'Check .psd1 file with Test-ModuleManifest'
  - stage: Release
    displayName: 'Release AzFilesHybrid'
    jobs:
      - job: CodeSign
        displayName: 'Sign AzFilesHybrid'
        steps:
          - checkout: none
          - task: EsrpCodeSigning@5
            displayName: 'Sign PowerShell code'
            inputs:
              ConnectedServiceName: 'AzFilesHybrid-Sign'
              AppRegistrationClientId: $(AppRegistrationClientId)
              AppRegistrationTenantId: $(AppRegistrationTenantId)
              UseMSIAuthentication: true
              AuthAKVName: $(AuthAKVName)
              AuthSignCertName: $(AuthSignCertName)
              AuthCertName: $(AuthCertName)
              FolderPath: 'AzFilesHybrid\AzFilesHybrid'
              Pattern: '*.ps1,*.psm1,*.psd1'
              SessionTimeout: 90
              ServiceEndpointUrl: 'https://api.esrp.microsoft.com/api/v2'
              MaxConcurrency: 25
              MaxRetryAttempts: 3
              PendingAnalysisWaitTimeoutMinutes: 5
              signConfigType: inlineSignParams
              VerboseLogin: true
              inlineOperation: |
                [
                  {
                    "KeyCode": "CP-230012",
                    "OperationCode": "SigntoolSign",
                    "Parameters": {
                      "OpusName": "Microsoft",
                      "OpusInfo": "http://www.microsoft.com",
                      "FileDigest": "/fd \"SHA256\"",
                      "PageHash": "/NPH",
                      "TimeStamp": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                    },
                    "ToolName": "sign",
                    "ToolVersion": "1.0"
                  },
                  {
                    "KeyCode": "CP-230012",
                    "OperationCode": "SigntoolVerify",
                    "Parameters": {},
                    "ToolName": "sign",
                    "ToolVersion": "1.0"
                  }
                ]